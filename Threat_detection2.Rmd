---
title: "Threat Detection"
output: html_document
date: "2024-04-21"
---



## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:



## Including Plots

You can also embed plots, for example:


```{r}

library(EBImage)
library(keras)



```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r}
```


```{r}
setwd('C:/GUNS2/AI_Images/guns21')

```







```{r}

# Directory containing the images
image_dir <- "C:/GUNS2/AI_Images/guns21"

# List all files in the directory
image_files <- list.files(image_dir, full.names = TRUE)

# Read images into a list
myimages <- lapply(image_files, readImage)

aimages <- myimages

```


```{r}
image_names <- basename(image_files)

# Print the names of all images
#print(image_names)

len = length(myimages)
len
```







```{r}
display(myimages[[2]])

```



```{r}
#Resize

```

```{r}
```


```{r}
for (i in 1:len)  {myimages[[i]] <- resize(myimages[[i]],28,28)}


for (i in 1:len)  {myimages[[i]] <- array_reshape(myimages[[i]], c(28, 28, 3))}

 
```



```{r}

class_labels <- ifelse(grepl("small_gun\\d+\\.jpg", image_names), 0,
                       ifelse(grepl("long_gun\\d+\\.jpg", image_names), 1, NA))

# Remove any NA values
class_labels <- class_labels[!is.na(class_labels)]

class_labels
```

```{r}

display(myimages[[114]])

```


```{r}

trainx <- NULL
testx <- NULL

for (i in 1:450) {trainx <- rbind(trainx,myimages[[i]])}
for (i in 465:646) {trainx <- rbind(trainx,myimages[[i]])}


for (i in 451:464) {testx <- rbind(testx,myimages[[i]])}
for (i in 647:656) {testx <- rbind(testx,myimages[[i]])}
trainy <- NULL
testy <- NULL

for (i in 1:450) {trainy <- rbind(trainy,class_labels[[i]])}
for (i in 465:646) {trainy <- rbind(trainy,class_labels[[i]])}


for (i in 451:464) {testy <- rbind(testy,class_labels[[i]])}
for (i in 647:656) {testy <- rbind(testy,class_labels[[i]])}


```

```{r}
str(trainx)
str(trainy)

```


```{r}



```

```{r}
trainLabels <- to_categorical(trainy)
testLables <- to_categorical(testy)

```



```{r}
model <- keras_model_sequential()
model %>%
  layer_dense(units = 256,activation = 'relu',input_shape = c(2352)) %>%
  layer_dense(unit = 128,activation = 'relu') %>%
  layer_dense(units = 2,activation = 'softmax')
  

```

```{r}
summary(model)
```
```{r}
model %>% compile(
  loss = 'binary_crossentropy',
  optimizer = optimizer_rmsprop(),
  metrics = c('accuracy')
)
```

```{r}
print(dim(trainx))
print(dim(testx))

```


```{r}
history <- model %>%
  fit(trainx,trainLabels,
      epochs = 30,
      batch_size = 32,
      validation_split = 0.2)

library(ggplot2)

# Create a data frame for training and validation metrics
history_df <- data.frame(
  epoch = 1:length(history$metrics$loss),
  loss = history$metrics$loss,
  val_loss = history$metrics$val_loss,
  accuracy = history$metrics$accuracy,
  val_accuracy = history$metrics$val_accuracy
)

# Melt the data frame for easier plotting
library(reshape2)
history_df <- melt(history_df, id.vars = "epoch")

# Plot loss
loss_plot <- ggplot(history_df, aes(x = epoch, y = value, color = variable)) +
  geom_line() +
  labs(title = "Training and Validation Loss",
       x = "Epochs",
       y = "Loss") +
  theme_minimal() +
  theme(legend.position = "bottom")

# Plot accuracy
accuracy_plot <- ggplot(history_df, aes(x = epoch, y = value, color = variable)) +
  geom_line() +
  labs(title = "Training and Validation Accuracy",
       x = "Epochs",
       y = "Accuracy") +
  theme_minimal() +
  theme(legend.position = "bottom")

# Display the plots
loss_plot
accuracy_plot


      

```

```{r}
trainLabels
```

```{r}
plot(history)
```
```{r}
model %>% evaluate(trainx,trainLabels)


```
```{r}
# Assuming your model is named 'model'
# Predict probabilities for each class
pred_prob <- model %>% predict(trainx)

# Threshold the predicted probabilities
threshold <- 0.5
tpredictions <- ifelse(pred_prob[, 2] > threshold, 1, 0)

# Print the predictions
print(tpredictions)



```

```{r}

table(Predicted = tpredictions,Actual = trainy)

```
```{r}
model %>% evaluate(testx,testLables)

```




```{r}
pred_prob <- model %>% predict(testx)

# Threshold the predicted probabilities
threshold <- 0.5
predictions <- ifelse(pred_prob[, 2] > threshold, 1, 0)

# Print the predictions
print(predictions)
```

```{r}
# Define the index column sequence
index_sequence <- c(61:68, 115:119)

# Repeat the index sequence to match the desired number of rows
num_rows <- 13  # Change this to the desired number of rows
index_column <- rep(index_sequence, length.out = num_rows)

# Combine the predicted probabilities, predictions, actual labels, and index column
```


```{r}
result <- cbind(index = index_column, pred_prob, Predit = predictions, Actual = testy)

result

```


```{r}

display(aimages[[115]])

```

```{r}
# Define labels
labels <- c("Small Gun", "Long Gun")
matching_indices <- which(predictions == testy)

matching_indices


# Find indices where predictions match actual labels
```
```{r}
labels <- c("Small Gun", "Long Gun")
matching_indices1 <- which(predictions != testy)

matching_indices1

```

```{r}
result[matching_indices, "index"]


```


```{r}

# Display images where predictions match actual labels along with their labels and corresponding index values
for (i in matching_indices) {
  # Get the corresponding index value
  index_value <- result[i, "index"]
  
  # Plot the image
  plot(aimages[[index_value]])
  
  # Get the actual and predicted labels
  actual_label <- labels[testy[i] + 1]  # +1 to index labels properly
  predicted_label <- labels[predictions[i] + 1]  # +1 to index labels properly
  
  # Add title with actual and predicted labels along with the index value
  title(paste("Image", i, "(Index:", index_value, "): Actual =", actual_label, ", Predicted =", predicted_label))
}



```
```{r}
# Display images where predictions match actual labels along with their labels and corresponding index values
for (i in matching_indices1) {
  # Get the corresponding index value
  index_value <- result[i, "index"]
  
  # Plot the image
  plot(aimages[[index_value]])
  
  # Get the actual and predicted labels
  actual_label <- labels[testy[i] + 1]  # +1 to index labels properly
  predicted_label <- labels[predictions[i] + 1]  # +1 to index labels properly
  
  # Add title with actual and predicted labels along with the index value
  title(paste("Image", i, "(Index:", index_value, "): Actual =", actual_label, ", Predicted =", predicted_label))
}
```
 

